---
- name: Minimal Elastic VM configuration for 6-node lab
  hosts: localhost
  become: yes
  gather_facts: false

  vars:
    nodes:
      - { name: "udl-prd-ms1", ip: "192.168.100.28" }
      - { name: "udl-prd-ms2", ip: "192.168.100.32" }
      - { name: "udl-prd-ms2", ip: "192.168.100.26" }
      - { name: "udl-dn-1", ip: "192.168.100.30" }
      - { name: "udl-dn-2", ip: "192.168.100.31" }
      - { name: "udl-dn-3", ip: "192.168.100.27" }

  tasks:

    - name: Disable Transparent HugePages
      shell: |
        echo never > /sys/kernel/mm/transparent_hugepage/enabled
        echo never > /sys/kernel/mm/transparent_hugepage/defrag
        echo "echo never > /sys/kernel/mm/transparent_hugepage/enabled" >> /etc/rc.d/rc.local
        echo "echo never > /sys/kernel/mm/transparent_hugepage/defrag" >> /etc/rc.d/rc.local
        chmod +x /etc/rc.d/rc.local
      args:
        warn: false

    - name: Set disk read-ahead for sdb
      shell: |
        echo 0 > /sys/class/block/sdb/queue/read_ahead_kb
        echo "echo 0 > /sys/class/block/sdb/queue/read_ahead_kb" >> /etc/rc.local
      args:
        warn: false

    - name: Disable SELinux
      lineinfile:
        path: /etc/selinux/config
        regexp: '^SELINUX='
        line: SELINUX=disabled

    - name: Update /etc/hosts with all nodes
      lineinfile:
        path: /etc/hosts
        line: "{{ item.ip }} {{ item.name }}"
        create: yes
      loop: "{{ nodes }}"

    - name: Regenerate GRUB2 config (for THP disable)
      shell: /usr/sbin/grub2-mkconfig -o /boot/grub2/grub.cfg
      args:
        warn: false
